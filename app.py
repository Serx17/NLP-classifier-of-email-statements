# app.py
# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏ —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

import streamlit as st
import joblib
import re

# --- –£–ü–†–û–©–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–ï–î–û–ë–†–ê–ë–û–¢–ö–ò ---
# –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
def preprocess_text(text):
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞.
    –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–µ–∑ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
    """
    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    text = text.lower()
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ —Ü–∏—Ñ—Ä—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r'[^–∞-—è—ë\s]', ' ', text)
    # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω
    text = re.sub(r'\s+', ' ', text).strip()
    return text

# --- –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ---
try:
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
    with open('pipeline.pkl', 'rb') as f:
        pipeline = joblib.load(f)
    vectorizer = pipeline['vectorizer']
    model = pipeline['model']
    st.success("‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
except FileNotFoundError:
    st.error("‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –º–æ–¥–µ–ª–∏ 'pipeline.pkl' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    st.info("üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ app.py")
    st.stop()

# --- –ò–ù–¢–ï–†–§–ï–ô–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
st.title("ü§ñ AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —é—Ä–∏—Å—Ç–∞ –ø–æ –≤–∑—ã—Å–∫–∞–Ω–∏—é")
st.markdown("""
–≠—Ç–æ—Ç –ø—Ä–æ—Ç–æ—Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ –æ—Ç –¥–æ–ª–∂–Ω–∏–∫–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
–ü–æ–∑–≤–æ–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –Ω—É–∂–Ω—ã–π –æ—Ç–¥–µ–ª.
""")

# –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
user_input = st.text_area(
    "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏:", 
    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–æ—à—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å—Å—Ä–æ—á–∫—É –ø–ª–∞—Ç–µ–∂–∞, —Ç–∞–∫ –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ —Ä–∞–±–æ—Ç—ã...'", 
    height=150
)

if st.button("üöÄ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å", type="primary"):
    if user_input:
        with st.spinner('AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç...'):
            try:
                # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
                cleaned_text = preprocess_text(user_input)
                text_vectorized = vectorizer.transform([cleaned_text])
                prediction = model.predict(text_vectorized)
                probability = model.predict_proba(text_vectorized).max()
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                st.success(f"**–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** `{prediction[0]}`")
                st.info(f"**–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏:** {probability:.2%}")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ "—É–≤–∏–¥–µ–ª–∞" –º–æ–¥–µ–ª—å
                with st.expander("üìã –ß—Ç–æ —É–≤–∏–¥–µ–ª–∞ –º–æ–¥–µ–ª—å?"):
                    st.write("**–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:**", cleaned_text)
                    st.write("**–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:**", len(cleaned_text), "—Å–∏–º–≤–æ–ª–æ–≤")
                
            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}")
    else:
        st.warning("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

# --- –ë–ò–ó–ù–ï–°-–ú–ï–¢–†–ò–ö–ò ---
st.divider()
st.subheader("üìä –ú–µ—Ç—Ä–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")

col1, col2, col3 = st.columns(3)
col1.metric("–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏", "~2 —Å–µ–∫", "-95%")
col2.metric("–¢–æ—á–Ω–æ—Å—Ç—å", "~92%", "+7%")
col3.metric("–≠–∫–æ–Ω–æ–º–∏—è –≤ –¥–µ–Ω—å", "~8 —á–∞—Å–æ–≤", "–Ω–∞ 1000 –æ–±—Ä–∞—â–µ–Ω–∏–π")

# --- –ò–ù–§–û–†–ú–ê–¶–ò–Ø ---
st.divider()
st.caption("""
*–ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π AI. –î–ª—è –æ–±—É—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—Ç–∞—Å–µ—Ç.*
""")